generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  SUPERADMIN
  ADMIN
  TREINADOR
  RESPONSAVEL
  ALUNO_FUTEBOL
  ALUNO_CROSSFIT
  FUNCIONARIO
}

// ==================== USUÁRIO ====================
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  password  String // ← ADICIONE ESTE CAMPO!
  role      Role
  img       String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  escolinha     Escolinha?       @relation(fields: [escolinhaId], references: [id])
  escolinhaId   String?
  alunoFutebol  AlunoFutebol?
  alunoCrossfit ClienteCrossfit?
  responsavel   Responsavel?
  funcionario   Funcionario?
}

// ==================== PLANOS SAAS ====================
model PlanoSaaS {
  id           String   @id @default(uuid())
  nome         String
  slug         String   @unique
  valorMensal  Float
  valorAnual   Float?
  limiteAlunos Int?
  features     String[]
  ativo        Boolean  @default(true)
  ordem        Int

  escolinhas Escolinha[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==================== PAGAMENTOS ====================
enum PagamentoStatus {
  PENDENTE
  CONFIRMADO
  ATRASADO
  CANCELADO
}

model Pagamento {
  id          String    @id @default(uuid())
  escolinhaId String
  escolinha   Escolinha @relation(fields: [escolinhaId], references: [id])

  responsavelId String?
  responsavel   Responsavel? @relation(fields: [responsavelId], references: [id])

  valor          Float
  dataVencimento DateTime? // ← ADICIONE: data prevista para pagamento
  dataPagamento  DateTime?       @default(now()) // ← permite null se ainda não pago
  metodo         String?
  tipo           String // "mensalidade_futebol", "mensalidade_crossfit", "aula_extra", "saas"
  referenciaId   String
  status         PagamentoStatus @default(PENDENTE) // ← use enum para consistência
  comprovanteUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  aulaExtras           AulaExtra[]
  mensalidadeCrossfits MensalidadeCrossfit[]
  mensalidadeFutebols  MensalidadeFutebol[]

  @@index([escolinhaId, dataVencimento])
  @@index([escolinhaId, status])
  @@index([tipo])
}

// ==================== ESCOLINHA ====================
model Escolinha {
  id       String  @id @default(uuid())
  nome     String
  endereco String?
  logoUrl  String?

  // NOVOS CAMPOS ADICIONADOS
  cidade      String? // Cidade (ex: "Cabo de Santo Agostinho")
  estado      String? // Estado (ex: "PE", "SP", "RJ"...)
  observacoes String? // Observações gerais (texto livre)

  // DOCUMENTO DA ESCOLINHA
  tipoDocumento   String? // "cpf" ou "cnpj"
  documento       String? @unique
  nomeResponsavel String?
  emailContato    String?
  telefone        String?

  // PLANO SAAS (o que a escolinha paga ao FutElite — configurável no painel dela)
  planoSaaS           String // "basico", "pro", "enterprise" — escolhido pela escolinha
  valorPlanoMensal    Float // valor atual do plano (ex: 150.00, 300.00, 500.00)
  dataInicioPlano     DateTime?
  dataProximoCobranca DateTime?
  statusPagamentoSaaS String    @default("ativo") // ativo, atrasado, suspenso, cancelado

  // VALORES QUE A ESCOLINHA COBRA DOS ALUNOS (CONFIGURÁVEIS NO PAINEL DA ESCOLINHA)
  valorMensalidadeFutebol  Float // OBRIGATÓRIO — admin define no painel
  valorMensalidadeCrossfit Float? // OPCIONAL — só se crossfitAtivo = true
  valorAulaExtraPadrao     Float? // OPCIONAL — valor base para aulas extras
  diaVencimento            Int // Dia do mês que vence (1 a 31)

  // MÓDULOS
  aulasExtrasAtivas Boolean @default(false)
  crossfitAtivo     Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  users                User[]
  alunosFutebol        AlunoFutebol[]
  alunosCrossfit       ClienteCrossfit[]
  funcionarios         Funcionario[]
  responsaveis         Responsavel[]
  treinos              Treino[]
  aulasExtras          AulaExtra[]
  mensalidadesFutebol  MensalidadeFutebol[]
  mensalidadesCrossfit MensalidadeCrossfit[]
  pagamentos           Pagamento[]

  planoSaaSs PlanoSaaS[]

  presencas Presenca[]

  presencaCrossfits PresencaCrossfit[]

  avaliacaos Avaliacao[]

  @@index([cidade, estado])
}

// ==================== FUNCIONÁRIO ====================
model Funcionario {
  id       String  @id @default(uuid())
  nome     String
  cargo    String // "treinador", "admin", "secretaria", etc
  salario  Float?
  fotoUrl  String?
  telefone String?
  email    String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  escolinha   Escolinha @relation(fields: [escolinhaId], references: [id])
  escolinhaId String

  user   User?   @relation(fields: [userId], references: [id])
  userId String? @unique

  treinos     Treino[]
  avaliacoes  Avaliacao[]
  aulasExtras AulaExtra[]
}

// ==================== ALUNO FUTEBOL ====================
model AlunoFutebol {
  id             String   @id @default(uuid())
  nome           String
  cpf            String?  @unique
  idade          Int
  categoria      String
  fotoUrl        String?
  frequenciaMes  Int      @default(0)
  mediaAvaliacao Float    @default(0)
  createdAt      DateTime @default(now())

  escolinha     Escolinha            @relation(fields: [escolinhaId], references: [id])
  escolinhaId   String
  responsavel   Responsavel          @relation(fields: [responsavelId], references: [id])
  responsavelId String
  avaliacoes    Avaliacao[]
  presencas     Presenca[]
  mensalidades  MensalidadeFutebol[]
  user          User?                @relation(fields: [userId], references: [id])
  userId        String?              @unique

  aulaExtras AulaExtra[]
}

// ==================== ALUNO CROSSFIT ====================
model ClienteCrossfit {
  id         String   @id @default(uuid())
  nome       String
  cpf        String?  @unique
  email      String   @unique
  fotoUrl    String?
  frequencia Int      @default(0)
  createdAt  DateTime @default(now())

  escolinha    Escolinha             @relation(fields: [escolinhaId], references: [id])
  escolinhaId  String
  presencas    PresencaCrossfit[]
  mensalidades MensalidadeCrossfit[]
  user         User?                 @relation(fields: [userId], references: [id])
  userId       String?               @unique
}

// ==================== RESPONSÁVEL ====================
model Responsavel {
  id        String   @id @default(uuid())
  nome      String
  cpf       String?  @unique
  email     String   @unique
  telefone  String?
  fotoUrl   String?
  createdAt DateTime @default(now())

  escolinha   Escolinha      @relation(fields: [escolinhaId], references: [id])
  escolinhaId String
  filhos      AlunoFutebol[]
  pagamentos  Pagamento[]
  user        User?          @relation(fields: [userId], references: [id])
  userId      String?        @unique
}

// ==================== FINANCEIRO ====================
model MensalidadeFutebol {
  id              String       @id @default(uuid())
  alunoId         String
  aluno           AlunoFutebol @relation(fields: [alunoId], references: [id])
  escolinhaId     String
  escolinha       Escolinha    @relation(fields: [escolinhaId], references: [id])
  mesReferencia   DateTime
  valor           Float
  dataVencimento  DateTime
  dataPagamento   DateTime?
  status          String       @default("pendente")
  metodoPagamento String?
  pagamentoId     String?
  pagamento       Pagamento?   @relation(fields: [pagamentoId], references: [id])
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@unique([alunoId, mesReferencia])
}

// ==================== MENSALIDADE CROSSFIT ====================
model MensalidadeCrossfit {
  id              String          @id @default(uuid())
  clienteId       String
  cliente         ClienteCrossfit @relation(fields: [clienteId], references: [id])
  escolinhaId     String
  escolinha       Escolinha       @relation(fields: [escolinhaId], references: [id])
  mesReferencia   DateTime
  valor           Float
  dataVencimento  DateTime
  dataPagamento   DateTime?
  status          String          @default("pendente")
  metodoPagamento String?
  pagamentoId     String?
  pagamento       Pagamento?      @relation(fields: [pagamentoId], references: [id])
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@unique([clienteId, mesReferencia])
}

// ==================== AULAS EXTRAS ====================
model AulaExtra {
  id     String   @id @default(uuid())
  data   DateTime
  hora   String
  tipo   String
  valor  Float
  status String   @default("agendada")

  alunoId String
  aluno   AlunoFutebol @relation(fields: [alunoId], references: [id])

  treinadorId String?
  treinador   Funcionario? @relation(fields: [treinadorId], references: [id])

  escolinhaId String
  escolinha   Escolinha @relation(fields: [escolinhaId], references: [id])

  pagamentoId String?
  pagamento   Pagamento? @relation(fields: [pagamentoId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==================== TREINO ====================
model Treino {
  id         String   @id @default(uuid())
  nome       String
  descricao  String?
  data       DateTime
  horaInicio String
  horaFim    String
  categoria  String
  local      String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  escolinha   Escolinha @relation(fields: [escolinhaId], references: [id])
  escolinhaId String

  treinador   Funcionario @relation(fields: [treinadorId], references: [id])
  treinadorId String

  presencas Presenca[]
}

// ==================== PRESENÇA FUTEBOL ====================
model Presenca {
  id       String   @id @default(uuid())
  presente Boolean  @default(false)
  data     DateTime @default(now())

  // Relação direta com aluno
  alunoId String
  aluno   AlunoFutebol @relation(fields: [alunoId], references: [id])

  // Relação direta com treino
  treinoId String
  treino   Treino @relation(fields: [treinoId], references: [id])

  // Relação DIRETA com a escolinha (para relatórios rápidos)
  escolinhaId String
  escolinha   Escolinha @relation(fields: [escolinhaId], references: [id])

  createdAt DateTime @default(now())

  @@unique([alunoId, treinoId])
  @@index([escolinhaId, data]) // para relatórios de frequência por mês/escolinha
}

// ==================== PRESENÇA CROSSFIT ====================
model PresencaCrossfit {
  id   String   @id @default(uuid())
  data DateTime @default(now())

  // Relação direta com cliente
  clienteId String
  cliente   ClienteCrossfit @relation(fields: [clienteId], references: [id])

  // Relação DIRETA com a escolinha
  escolinhaId String
  escolinha   Escolinha @relation(fields: [escolinhaId], references: [id])

  createdAt DateTime @default(now())

  @@unique([clienteId, data])
  @@index([escolinhaId, data]) // relatórios CrossFit por mês
}

// ==================== AVALIAÇÃO ====================
model Avaliacao {
  id                     String   @id @default(uuid())
  notaControleBola       Float
  notaPasse              Float
  notaDrible             Float
  notaFinalizacao        Float
  notaCondicionamento    Float
  notaInteligenciaTatica Float
  notaComportamento      Float
  media                  Float
  comentario             String?
  data                   DateTime @default(now())

  // Relação com aluno
  alunoId String
  aluno   AlunoFutebol @relation(fields: [alunoId], references: [id])

  // Relação com treinador
  treinadorId String
  treinador   Funcionario @relation(fields: [treinadorId], references: [id])

  // Relação DIRETA com a escolinha
  escolinhaId String
  escolinha   Escolinha @relation(fields: [escolinhaId], references: [id])

  createdAt DateTime @default(now())

  @@index([escolinhaId, data]) // relatórios de evolução por período
}
